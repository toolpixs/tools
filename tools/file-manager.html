<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced File Manager | ToolPix</title>
  <meta name="description" content="Powerful file manager with folder organization, previews, and advanced features">
  <meta name="keywords" content="file manager, document organizer, cloud storage, productivity tools">
  <meta name="robots" content="index, follow">
  <meta name="author" content="ToolPix">

  <!-- Canonical URL -->
  <link rel="canonical" href="https://toolpixs.github.io/tools/productivity-tools/advanced-file-manager" />

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- CSS -->
  <style>
    :root {
      --primary: #6B48FF;
      --primary-dark: #5B3BD6;
      --primary-light: #E8E6FF;
      --secondary: #FF6B6B;
      --text: #333;
      --text-light: #666;
      --bg: #F5F5FA;
      --card-bg: #fff;
      --border: #e0e0e0;
      --shadow: rgba(0,0,0,0.1);
      --radius-md: 12px;
      --radius-sm: 8px;
      --transition: all 0.3s ease;
      --success: #4CAF50;
      --warning: #FFC107;
      --danger: #F44336;
      --info: #2196F3;
    }

    html.dark-mode {
      --text: #f0f0f0;
      --text-light: #bbb;
      --bg: #121212;
      --card-bg: #1e1e1e;
      --border: #333;
      --primary-light: #2A1D6E;
    }

    @media (prefers-color-scheme: dark) {
      html:not(.dark-mode):not(.light-mode) {
        --text: #f0f0f0;
        --text-light: #bbb;
        --bg: #121212;
        --card-bg: #1e1e1e;
        --border: #333;
        --primary-light: #2A1D6E;
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* Splash Screen */
    .splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      transition: opacity 0.5s ease;
    }

    .splash-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .splash-logo {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-top: 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Welcome Modal */
    .welcome-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9998;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .welcome-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .welcome-content {
      text-align: center;
      color: white;
      max-width: 500px;
      padding: 2rem;
    }

    .welcome-content i {
      font-size: 5rem;
      margin-bottom: 2rem;
      opacity: 0.8;
    }

    .welcome-content h1 {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .welcome-content p {
      font-size: 1rem;
      opacity: 0.8;
      margin-bottom: 2rem;
    }

    .welcome-btn {
      background: linear-gradient(135deg, var(--secondary), #FF8E53);
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .welcome-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    /* App Layout */
    .app-container {
      display: none;
      flex-direction: column;
      min-height: 100vh;
    }

    .app-container.active {
      display: flex;
    }

    /* App Header */
    .app-header {
      display: flex;
      align-items: center;
      padding: 1rem;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav-back {
      background: none;
      border: none;
      font-size: 1.2rem;
      color: var(--text);
      cursor: pointer;
      margin-right: 1rem;
      display: none;
    }

    .nav-back.active {
      display: block;
    }

    .app-title {
      font-size: 1.2rem;
      font-weight: 600;
      flex-grow: 1;
    }

    .search-container {
      display: none;
      flex-grow: 1;
      margin: 0 1rem;
      position: relative;
    }

    .search-container.active {
      display: block;
    }

    .search-input {
      width: 100%;
      padding: 0.5rem 1rem 0.5rem 2.5rem;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
    }

    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
    }

    .app-actions {
      display: flex;
      align-items: center;
    }

    .app-action-btn {
      background: none;
      border: none;
      font-size: 1.2rem;
      color: var(--text);
      cursor: pointer;
      margin-left: 1rem;
      position: relative;
    }

    .dropdown-menu {
      position: absolute;
      right: 0;
      top: 100%;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      min-width: 200px;
      z-index: 101;
      display: none;
      overflow: hidden;
    }

    .dropdown-menu.active {
      display: block;
    }

    .dropdown-item {
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .dropdown-item:hover {
      background: var(--primary-light);
    }

    .dropdown-item i {
      margin-right: 0.75rem;
      width: 20px;
      text-align: center;
    }

    /* Path Breadcrumbs */
    .path-breadcrumbs {
      display: flex;
      padding: 0.5rem 1rem;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      white-space: nowrap;
    }

    .breadcrumb-item {
      display: flex;
      align-items: center;
      cursor: pointer;
      color: var(--text-light);
      transition: var(--transition);
    }

    .breadcrumb-item:hover {
      color: var(--primary);
    }

    .breadcrumb-item:after {
      content: '/';
      margin: 0 0.5rem;
      color: var(--text-light);
    }

    .breadcrumb-item:last-child:after {
      display: none;
    }

    .breadcrumb-item.active {
      color: var(--primary);
      font-weight: 500;
    }

    /* File Manager */
    .file-manager {
      flex-grow: 1;
      padding: 1rem;
      overflow-y: auto;
    }

    /* View Toggle */
    .view-toggle {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 1rem;
    }

    .view-btn {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: 0.5rem;
      transition: var(--transition);
    }

    .view-btn.active {
      color: var(--primary);
    }

    /* Grid View */
    .items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
    }

    .item-card {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      overflow: hidden;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid transparent;
      position: relative;
    }

    .item-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .item-card.selected {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .item-thumbnail {
      width: 100%;
      height: 100px;
      object-fit: cover;
      display: block;
    }

    .item-icon {
      width: 100%;
      height: 100px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 2.5rem;
      color: var(--primary);
    }

    .item-details {
      padding: 0.75rem;
    }

    .item-name {
      font-size: 0.85rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 0.25rem;
    }

    .item-meta {
      font-size: 0.75rem;
      color: var(--text-light);
      display: flex;
      justify-content: space-between;
    }

    .item-actions {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      width: 25px;
      height: 25px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      opacity: 0;
      transition: var(--transition);
    }

    .item-card:hover .item-actions {
      opacity: 1;
    }

    /* List View */
    .items-list {
      display: none;
    }

    .items-list.active {
      display: block;
    }

    .list-header {
      display: grid;
      grid-template-columns: 3fr 1fr 1fr 1fr;
      padding: 0.75rem 1rem;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0.5rem;
    }

    .list-item {
      display: grid;
      grid-template-columns: 3fr 1fr 1fr 1fr;
      padding: 0.75rem 1rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition);
    }

    .list-item:hover {
      background: var(--primary-light);
    }

    .list-item.selected {
      background: var(--primary-light);
    }

    .list-item-name {
      display: flex;
      align-items: center;
    }

    .list-item-icon {
      margin-right: 0.75rem;
      color: var(--primary);
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-light);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--primary);
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    /* Selection Bar */
    .selection-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--primary);
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transform: translateY(100%);
      transition: var(--transition);
      z-index: 100;
    }

    .selection-bar.active {
      transform: translateY(0);
    }

    .selection-count {
      font-weight: 600;
    }

    .selection-actions {
      display: flex;
      gap: 1rem;
    }

    .selection-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .selection-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Floating Action Buttons */
    .fab-container {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 1rem;
      z-index: 99;
    }

    .fab-main {
      background: var(--primary);
      color: white;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      transition: var(--transition);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .fab-main.active {
      transform: rotate(45deg);
    }

    .fab-menu {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      transform: scale(0);
      transform-origin: bottom right;
      transition: var(--transition);
      opacity: 0;
      pointer-events: none;
    }

    .fab-menu.active {
      transform: scale(1);
      opacity: 1;
      pointer-events: all;
    }

    .fab-item {
      background: var(--card-bg);
      color: var(--text);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .fab-item:hover {
      background: var(--primary-light);
      color: var(--primary);
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      padding: 1.5rem 1.5rem 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-light);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg);
      color: var(--text);
      font-family: inherit;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-sm);
      border: none;
      font-family: inherit;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }

    .btn-secondary:hover {
      background: #E64A19;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-outline:hover {
      background: var(--bg);
    }

    /* File Preview */
    .preview-container {
      text-align: center;
    }

    .preview-image {
      max-width: 100%;
      max-height: 60vh;
      border-radius: var(--radius-sm);
      margin-bottom: 1rem;
    }

    .preview-unsupported {
      padding: 2rem;
      text-align: center;
    }

    .preview-unsupported i {
      font-size: 3rem;
      color: var(--warning);
      margin-bottom: 1rem;
    }

    .preview-text {
      width: 100%;
      height: 60vh;
      padding: 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg);
      color: var(--text);
      font-family: monospace;
      resize: none;
      margin-bottom: 1rem;
    }

    .preview-actions {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
    }

    /* Properties */
    .properties-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 1rem;
    }

    .property-name {
      font-weight: 500;
      color: var(--text-light);
    }

    .property-value {
      word-break: break-all;
    }

    /* Status Popup */
    .status-container {
      padding: 1rem;
    }

    .status-item {
      margin-bottom: 1rem;
    }

    .status-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .status-bar {
      height: 8px;
      background: var(--bg);
      border-radius: 4px;
      overflow: hidden;
    }

    .status-progress {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
    }

    /* Recycle Bin */
    .recycle-bin-empty {
      text-align: center;
      padding: 2rem;
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
      .items-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }

      .list-header, .list-item {
        grid-template-columns: 2fr 1fr 1fr;
      }

      .list-header > div:nth-child(3),
      .list-item > div:nth-child(3) {
        display: none;
      }
    }

    @media (max-width: 480px) {
      .app-title {
        font-size: 1rem;
      }

      .items-grid {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      }

      .item-icon, .item-thumbnail {
        height: 80px;
      }

      .list-header, .list-item {
        grid-template-columns: 1fr 1fr;
      }

      .list-header > div:nth-child(2),
      .list-item > div:nth-child(2) {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Splash Screen -->
  <div class="splash-screen">
    <div class="splash-logo">File Manager</div>
    <div class="loading-spinner"></div>
  </div>

  <!-- Welcome Modal -->
  <div class="welcome-modal">
    <div class="welcome-content">
      <i class="fas fa-folder-open"></i>
      <h1>Welcome to File Manager</h1>
      <p>Organize your files with ease and access them from anywhere</p>
      <button class="welcome-btn" id="startUsingBtn">
        <i class="fas fa-arrow-right"></i>
      </button>
    </div>
  </div>

  <!-- App Container -->
  <div class="app-container">
    <!-- App Header -->
    <header class="app-header">
      <button class="nav-back" id="navBackBtn">
        <i class="fas fa-arrow-left"></i>
      </button>
      
      <div class="app-title" id="currentFolderTitle">My Files</div>
      
      <div class="search-container" id="searchContainer">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" id="searchInput" placeholder="Search files..." aria-label="Search files">
      </div>
      
      <div class="app-actions">
        <button class="app-action-btn" id="searchBtn">
          <i class="fas fa-search"></i>
        </button>
        <button class="app-action-btn" id="moreActionsBtn">
          <i class="fas fa-ellipsis-v"></i>
        </button>
        
        <!-- More Actions Dropdown -->
        <div class="dropdown-menu" id="moreActionsMenu">
          <div class="dropdown-item" id="searchActionBtn">
            <i class="fas fa-search"></i>
            <span>Search</span>
          </div>
          <div class="dropdown-item" id="sortActionBtn">
            <i class="fas fa-sort"></i>
            <span>Sort by</span>
          </div>
          <div class="dropdown-item" id="statusActionBtn">
            <i class="fas fa-chart-pie"></i>
            <span>Status</span>
          </div>
          <div class="dropdown-item" id="recycleBinActionBtn">
            <i class="fas fa-trash"></i>
            <span>Recycle Bin</span>
          </div>
          <div class="dropdown-item" id="darkModeActionBtn">
            <i class="fas fa-moon"></i>
            <span>Dark Mode</span>
          </div>
        </div>
      </div>
    </header>
    
    <!-- Sort By Dropdown -->
    <div class="dropdown-menu" id="sortByMenu">
      <div class="dropdown-item" data-sort="name-asc">
        <i class="fas fa-sort-alpha-down"></i>
        <span>Name (A-Z)</span>
      </div>
      <div class="dropdown-item" data-sort="name-desc">
        <i class="fas fa-sort-alpha-up"></i>
        <span>Name (Z-A)</span>
      </div>
      <div class="dropdown-item" data-sort="date-asc">
        <i class="fas fa-sort-numeric-down"></i>
        <span>Date (Oldest)</span>
      </div>
      <div class="dropdown-item" data-sort="date-desc">
        <i class="fas fa-sort-numeric-up"></i>
        <span>Date (Newest)</span>
      </div>
      <div class="dropdown-item" data-sort="size-asc">
        <i class="fas fa-sort-amount-down"></i>
        <span>Size (Smallest)</span>
      </div>
      <div class="dropdown-item" data-sort="size-desc">
        <i class="fas fa-sort-amount-up"></i>
        <span>Size (Largest)</span>
      </div>
    </div>
    
    <!-- Path Breadcrumbs -->
    <div class="path-breadcrumbs" id="pathBreadcrumbs">
      <div class="breadcrumb-item active" data-path="/">Home</div>
    </div>
    
    <!-- File Manager -->
    <main class="file-manager">
      <!-- View Toggle -->
      <div class="view-toggle">
        <button class="view-btn active" id="gridViewBtn" title="Grid view">
          <i class="fas fa-th-large"></i>
        </button>
        <button class="view-btn" id="listViewBtn" title="List view">
          <i class="fas fa-list"></i>
        </button>
      </div>
      
      <!-- Grid View -->
      <div class="items-grid" id="itemsGrid">
        <!-- Items will be rendered here -->
      </div>
      
      <!-- List View -->
      <div class="items-list" id="itemsList">
        <div class="list-header">
          <div>Name</div>
          <div>Size</div>
          <div>Type</div>
          <div>Modified</div>
        </div>
        <div id="listItemsContainer">
          <!-- List items will be rendered here -->
        </div>
      </div>
      
      <!-- Empty State -->
      <div class="empty-state" id="emptyState">
        <i class="fas fa-folder-open"></i>
        <h3>No Files Yet</h3>
        <p>Upload your first file to get started!</p>
      </div>
    </main>
    
    <!-- Selection Bar -->
    <div class="selection-bar" id="selectionBar">
      <div class="selection-count" id="selectionCount">0 selected</div>
      <div class="selection-actions">
        <button class="selection-btn" id="copySelectedBtn">
          <i class="fas fa-copy"></i> Copy
        </button>
        <button class="selection-btn" id="deleteSelectedBtn">
          <i class="fas fa-trash"></i> Delete
        </button>
      </div>
    </div>
    
    <!-- Floating Action Buttons -->
    <div class="fab-container">
      <div class="fab-menu" id="fabMenu">
        <button class="fab-item" id="uploadFabBtn" title="Upload file">
          <i class="fas fa-upload"></i>
        </button>
        <button class="fab-item" id="newFolderFabBtn" title="New folder">
          <i class="fas fa-folder-plus"></i>
        </button>
        <button class="fab-item" id="pasteFabBtn" title="Paste" style="display: none;">
          <i class="fas fa-paste"></i>
        </button>
      </div>
      <button class="fab-main" id="fabMainBtn">
        <i class="fas fa-plus"></i>
      </button>
    </div>
  </div>
  
  <!-- Upload Modal -->
  <div class="modal-overlay" id="uploadModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Upload File</h3>
        <button class="modal-close" id="closeUploadModalBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="uploadFileName" class="form-label">File Name</label>
          <input type="text" id="uploadFileName" class="form-control" placeholder="Enter file name">
        </div>
        <div class="form-group">
          <label for="uploadFileInput" class="form-label">Select File</label>
          <input type="file" id="uploadFileInput" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelUploadBtn">Cancel</button>
        <button class="btn btn-primary" id="confirmUploadBtn">Upload</button>
      </div>
    </div>
  </div>
  
  <!-- New Folder Modal -->
  <div class="modal-overlay" id="newFolderModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">New Folder</h3>
        <button class="modal-close" id="closeNewFolderModalBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="folderName" class="form-label">Folder Name</label>
          <input type="text" id="folderName" class="form-control" value="New folder" placeholder="Enter folder name">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelNewFolderBtn">Cancel</button>
        <button class="btn btn-primary" id="confirmNewFolderBtn">Create</button>
      </div>
    </div>
  </div>
  
  <!-- File Preview Modal -->
  <div class="modal-overlay" id="filePreviewModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="previewTitle">File Preview</h3>
        <button class="modal-close" id="closePreviewModalBtn">&times;</button>
      </div>
      <div class="modal-body" id="previewContent">
        <!-- Content will be dynamically loaded -->
      </div>
      <div class="modal-footer">
        <div class="preview-actions">
          <button class="btn btn-outline" id="downloadPreviewBtn">
            <i class="fas fa-download"></i> Download
          </button>
          <button class="btn btn-outline" id="copyPreviewBtn">
            <i class="fas fa-copy"></i> Copy
          </button>
          <button class="btn btn-outline" id="propertiesPreviewBtn">
            <i class="fas fa-info-circle"></i> Properties
          </button>
          <button class="btn btn-secondary" id="deletePreviewBtn">
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Properties Modal -->
  <div class="modal-overlay" id="propertiesModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Properties</h3>
        <button class="modal-close" id="closePropertiesModalBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="properties-grid" id="propertiesGrid">
          <!-- Properties will be dynamically loaded -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="closePropertiesBtn">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Sort By Modal -->
  <div class="modal-overlay" id="sortByModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Sort By</h3>
        <button class="modal-close" id="closeSortByModalBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="dropdown-menu" style="position: relative; box-shadow: none;">
          <div class="dropdown-item" data-sort="name-asc">
            <i class="fas fa-sort-alpha-down"></i>
            <span>Name (A-Z)</span>
          </div>
          <div class="dropdown-item" data-sort="name-desc">
            <i class="fas fa-sort-alpha-up"></i>
            <span>Name (Z-A)</span>
          </div>
          <div class="dropdown-item" data-sort="date-asc">
            <i class="fas fa-sort-numeric-down"></i>
            <span>Date (Oldest)</span>
          </div>
          <div class="dropdown-item" data-sort="date-desc">
            <i class="fas fa-sort-numeric-up"></i>
            <span>Date (Newest)</span>
          </div>
          <div class="dropdown-item" data-sort="size-asc">
            <i class="fas fa-sort-amount-down"></i>
            <span>Size (Smallest)</span>
          </div>
          <div class="dropdown-item" data-sort="size-desc">
            <i class="fas fa-sort-amount-up"></i>
            <span>Size (Largest)</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="closeSortByBtn">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Status Modal -->
  <div class="modal-overlay" id="statusModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Storage Status</h3>
        <button class="modal-close" id="closeStatusModalBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="status-container" id="statusContainer">
          <!-- Status will be dynamically loaded -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="closeStatusBtn">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Recycle Bin Modal -->
  <div class="modal-overlay" id="recycleBinModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Recycle Bin</h3>
        <button class="modal-close" id="closeRecycleBinModalBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="items-list active" id="recycleBinList">
          <div class="list-header">
            <div>Name</div>
            <div>Original Path</div>
            <div>Deleted Date</div>
            <div>Size</div>
          </div>
          <div id="recycleBinItemsContainer">
            <!-- Recycle bin items will be rendered here -->
          </div>
        </div>
        
        <div class="recycle-bin-empty" id="recycleBinEmpty">
          <i class="fas fa-trash"></i>
          <h3>Recycle Bin is Empty</h3>
          <p>Deleted files will appear here</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="emptyRecycleBinBtn">
          <i class="fas fa-broom"></i> Empty Bin
        </button>
        <button class="btn btn-primary" id="closeRecycleBinBtn">Close</button>
      </div>
    </div>
  </div>

  <script>
    // DOM Elements
    const splashScreen = document.querySelector('.splash-screen');
    const welcomeModal = document.querySelector('.welcome-modal');
    const appContainer = document.querySelector('.app-container');
    const startUsingBtn = document.getElementById('startUsingBtn');
    
    // App Header
    const navBackBtn = document.getElementById('navBackBtn');
    const currentFolderTitle = document.getElementById('currentFolderTitle');
    const searchBtn = document.getElementById('searchBtn');
    const searchContainer = document.getElementById('searchContainer');
    const searchInput = document.getElementById('searchInput');
    const moreActionsBtn = document.getElementById('moreActionsBtn');
    const moreActionsMenu = document.getElementById('moreActionsMenu');
    const searchActionBtn = document.getElementById('searchActionBtn');
    const sortActionBtn = document.getElementById('sortActionBtn');
    const statusActionBtn = document.getElementById('statusActionBtn');
    const recycleBinActionBtn = document.getElementById('recycleBinActionBtn');
    const darkModeActionBtn = document.getElementById('darkModeActionBtn');
    const sortByMenu = document.getElementById('sortByMenu');
    
    // Path Breadcrumbs
    const pathBreadcrumbs = document.getElementById('pathBreadcrumbs');
    
    // File Manager
    const gridViewBtn = document.getElementById('gridViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');
    const itemsGrid = document.getElementById('itemsGrid');
    const itemsList = document.getElementById('itemsList');
    const listItemsContainer = document.getElementById('listItemsContainer');
    const emptyState = document.getElementById('emptyState');
    
    // Selection Bar
    const selectionBar = document.getElementById('selectionBar');
    const selectionCount = document.getElementById('selectionCount');
    const copySelectedBtn = document.getElementById('copySelectedBtn');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    
    // Floating Action Buttons
    const fabMainBtn = document.getElementById('fabMainBtn');
    const fabMenu = document.getElementById('fabMenu');
    const uploadFabBtn = document.getElementById('uploadFabBtn');
    const newFolderFabBtn = document.getElementById('newFolderFabBtn');
    const pasteFabBtn = document.getElementById('pasteFabBtn');
    
    // Modals
    const uploadModal = document.getElementById('uploadModal');
    const closeUploadModalBtn = document.getElementById('closeUploadModalBtn');
    const uploadFileName = document.getElementById('uploadFileName');
    const uploadFileInput = document.getElementById('uploadFileInput');
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');
    const confirmUploadBtn = document.getElementById('confirmUploadBtn');
    
    const newFolderModal = document.getElementById('newFolderModal');
    const closeNewFolderModalBtn = document.getElementById('closeNewFolderModalBtn');
    const folderName = document.getElementById('folderName');
    const cancelNewFolderBtn = document.getElementById('cancelNewFolderBtn');
    const confirmNewFolderBtn = document.getElementById('confirmNewFolderBtn');
    
    const filePreviewModal = document.getElementById('filePreviewModal');
    const closePreviewModalBtn = document.getElementById('closePreviewModalBtn');
    const previewTitle = document.getElementById('previewTitle');
    const previewContent = document.getElementById('previewContent');
    const downloadPreviewBtn = document.getElementById('downloadPreviewBtn');
    const copyPreviewBtn = document.getElementById('copyPreviewBtn');
    const propertiesPreviewBtn = document.getElementById('propertiesPreviewBtn');
    const deletePreviewBtn = document.getElementById('deletePreviewBtn');
    
    const propertiesModal = document.getElementById('propertiesModal');
    const closePropertiesModalBtn = document.getElementById('closePropertiesModalBtn');
    const propertiesGrid = document.getElementById('propertiesGrid');
    const closePropertiesBtn = document.getElementById('closePropertiesBtn');
    
    const sortByModal = document.getElementById('sortByModal');
    const closeSortByModalBtn = document.getElementById('closeSortByModalBtn');
    const closeSortByBtn = document.getElementById('closeSortByBtn');
    
    const statusModal = document.getElementById('statusModal');
    const closeStatusModalBtn = document.getElementById('closeStatusModalBtn');
    const statusContainer = document.getElementById('statusContainer');
    const closeStatusBtn = document.getElementById('closeStatusBtn');
    
    const recycleBinModal = document.getElementById('recycleBinModal');
    const closeRecycleBinModalBtn = document.getElementById('closeRecycleBinModalBtn');
    const recycleBinList = document.getElementById('recycleBinList');
    const recycleBinItemsContainer = document.getElementById('recycleBinItemsContainer');
    const recycleBinEmpty = document.getElementById('recycleBinEmpty');
    const emptyRecycleBinBtn = document.getElementById('emptyRecycleBinBtn');
    const closeRecycleBinBtn = document.getElementById('closeRecycleBinBtn');
    
    // App State
    let db;
    let currentPath = '/';
    let currentFolderId = 'root';
    let selectedItems = [];
    let copiedItems = [];
    let sortBy = 'name-asc';
    let viewMode = 'grid'; // 'grid' or 'list'
    let isSelectMode = false;
    
    // File Type Icons
    const fileIcons = {
      // Folders
      folder: 'fa-folder',
      
      // Images
      'image/jpeg': 'fa-file-image',
      'image/png': 'fa-file-image',
      'image/gif': 'fa-file-image',
      'image/svg+xml': 'fa-file-image',
      'image/webp': 'fa-file-image',
      
      // Documents
      'application/pdf': 'fa-file-pdf',
      'application/msword': 'fa-file-word',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'fa-file-word',
      'application/vnd.ms-excel': 'fa-file-excel',
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'fa-file-excel',
      'application/vnd.ms-powerpoint': 'fa-file-powerpoint',
      'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'fa-file-powerpoint',
      'text/plain': 'fa-file-alt',
      'text/csv': 'fa-file-csv',
      
      // Archives
      'application/zip': 'fa-file-archive',
      'application/x-rar-compressed': 'fa-file-archive',
      'application/x-7z-compressed': 'fa-file-archive',
      'application/x-tar': 'fa-file-archive',
      'application/gzip': 'fa-file-archive',
      
      // Code
      'text/html': 'fa-file-code',
      'text/css': 'fa-file-code',
      'application/javascript': 'fa-file-code',
      'application/json': 'fa-file-code',
      
      // Audio
      'audio/mpeg': 'fa-file-audio',
      'audio/ogg': 'fa-file-audio',
      'audio/wav': 'fa-file-audio',
      
      // Video
      'video/mp4': 'fa-file-video',
      'video/ogg': 'fa-file-video',
      'video/webm': 'fa-file-video',
      
      // Default
      default: 'fa-file'
    };
    
    // Initialize the app
    async function initApp() {
      setTimeout(() => {
        splashScreen.classList.add('hidden');
        const hasSeenWelcome = localStorage.getItem('hasSeenWelcome');
        if (!hasSeenWelcome) {
          welcomeModal.classList.add('active');
        } else {
          startApp();
        }
      }, 1500);
    }
    
    // Start the main app
    async function startApp() {
      try {
        await initDB();
        await loadCurrentFolder();
        setupEventListeners();
        
        // Check for dark mode preference
        if (localStorage.getItem('darkMode') === 'true' || 
            (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches && localStorage.getItem('darkMode') !== 'false')) {
          document.documentElement.classList.add('dark-mode');
        }
        
        appContainer.classList.add('active');
      } catch (error) {
        console.error('Error starting app:', error);
        alert('Failed to initialize the application. Please try refreshing the page.');
      }
    }
    
    // Initialize IndexedDB
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('FileManagerDB', 2);
        
        request.onerror = (event) => {
          console.error('Database error:', event.target.error);
          reject('Failed to open database');
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          
          // Create folders store
          if (!db.objectStoreNames.contains('folders')) {
            const foldersStore = db.createObjectStore('folders', { keyPath: 'id' });
            foldersStore.createIndex('parentId', 'parentId', { unique: false });
            
            // Add root folder if it doesn't exist
            foldersStore.put({
              id: 'root',
              name: 'Root',
              path: '/',
              parentId: null,
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString()
            });
          }
          
          // Create files store
          if (!db.objectStoreNames.contains('files')) {
            const filesStore = db.createObjectStore('files', { keyPath: 'id' });
            filesStore.createIndex('folderId', 'folderId', { unique: false });
          }
          
          // Create recycle bin store
          if (!db.objectStoreNames.contains('recycleBin')) {
            db.createObjectStore('recycleBin', { keyPath: 'id' });
          }
        };
        
        request.onsuccess = (event) => {
          db = event.target.result;
          resolve();
        };
      });
    }
    
    // Setup event listeners
    function setupEventListeners() {
      // Welcome modal
      startUsingBtn.addEventListener('click', () => {
        welcomeModal.classList.remove('active');
        localStorage.setItem('hasSeenWelcome', 'true');
        startApp();
      });
      
      // Navigation
      navBackBtn.addEventListener('click', navigateToParentFolder);
      
      // Search
      searchBtn.addEventListener('click', toggleSearch);
      searchActionBtn.addEventListener('click', toggleSearch);
      searchInput.addEventListener('input', debounce(handleSearch, 300));
      
      // More actions
      moreActionsBtn.addEventListener('click', toggleMoreActionsMenu);
      sortActionBtn.addEventListener('click', showSortByModal);
      statusActionBtn.addEventListener('click', showStatusModal);
      recycleBinActionBtn.addEventListener('click', showRecycleBinModal);
      darkModeActionBtn.addEventListener('click', toggleDarkMode);
      
      // View toggle
      gridViewBtn.addEventListener('click', () => switchView('grid'));
      listViewBtn.addEventListener('click', () => switchView('list'));
      
      // Selection bar
      copySelectedBtn.addEventListener('click', copySelectedItems);
      deleteSelectedBtn.addEventListener('click', deleteSelectedItems);
      
      // Floating action buttons
      fabMainBtn.addEventListener('click', toggleFabMenu);
      uploadFabBtn.addEventListener('click', showUploadModal);
      newFolderFabBtn.addEventListener('click', showNewFolderModal);
      pasteFabBtn.addEventListener('click', pasteItems);
      
      // Upload modal
      closeUploadModalBtn.addEventListener('click', hideUploadModal);
      cancelUploadBtn.addEventListener('click', hideUploadModal);
      confirmUploadBtn.addEventListener('click', uploadFile);
      
      // New folder modal
      closeNewFolderModalBtn.addEventListener('click', hideNewFolderModal);
      cancelNewFolderBtn.addEventListener('click', hideNewFolderModal);
      confirmNewFolderBtn.addEventListener('click', createNewFolder);
      
      // File preview modal
      closePreviewModalBtn.addEventListener('click', hideFilePreviewModal);
      downloadPreviewBtn.addEventListener('click', downloadPreviewedFile);
      copyPreviewBtn.addEventListener('click', copyPreviewedFile);
      propertiesPreviewBtn.addEventListener('click', showPropertiesForPreviewedFile);
      deletePreviewBtn.addEventListener('click', deletePreviewedFile);
      
      // Properties modal
      closePropertiesModalBtn.addEventListener('click', hidePropertiesModal);
      closePropertiesBtn.addEventListener('click', hidePropertiesModal);
      
      // Sort by modal
      closeSortByModalBtn.addEventListener('click', hideSortByModal);
      closeSortByBtn.addEventListener('click', hideSortByModal);
      
      // Status modal
      closeStatusModalBtn.addEventListener('click', hideStatusModal);
      closeStatusBtn.addEventListener('click', hideStatusModal);
      
      // Recycle bin modal
      closeRecycleBinModalBtn.addEventListener('click', hideRecycleBinModal);
      closeRecycleBinBtn.addEventListener('click', hideRecycleBinModal);
      emptyRecycleBinBtn.addEventListener('click', emptyRecycleBin);
      
      // Handle clicks on sort by dropdown items
      document.querySelectorAll('[data-sort]').forEach(item => {
        item.addEventListener('click', () => {
          sortBy = item.getAttribute('data-sort');
          loadCurrentFolder();
          hideSortByModal();
        });
      });
      
      // Close dropdowns when clicking outside
      document.addEventListener('click', (event) => {
        if (!moreActionsBtn.contains(event.target)) {
          moreActionsMenu.classList.remove('active');
        }
        
        if (!sortActionBtn.contains(event.target)) {
          sortByMenu.classList.remove('active');
        }
      });
    }
    
    // Toggle dark mode
    function toggleDarkMode() {
      const isDark = document.documentElement.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', isDark);
      hideMoreActionsMenu();
    }
    
    // Toggle search
    function toggleSearch() {
      searchContainer.classList.toggle('active');
      moreActionsMenu.classList.remove('active');
      
      if (searchContainer.classList.contains('active')) {
        searchInput.focus();
      } else {
        searchInput.value = '';
        loadCurrentFolder();
      }
    }
    
    // Handle search
    function handleSearch() {
      const query = searchInput.value.trim().toLowerCase();
      
      if (query === '') {
        loadCurrentFolder();
        return;
      }
      
      searchFiles(query);
    }
    
    // Search files
    async function searchFiles(query) {
      try {
        const files = await getAllFiles();
        const folders = await getAllFolders();
        
        const filteredFiles = files.filter(file => 
          file.name.toLowerCase().includes(query) || 
          file.type.toLowerCase().includes(query)
        );
        
        const filteredFolders = folders.filter(folder => 
          folder.name.toLowerCase().includes(query)
        );
        
        renderItems(filteredFolders, filteredFiles);
      } catch (error) {
        console.error('Error searching files:', error);
        alert('Failed to search files. Please try again.');
      }
    }
    
    // Toggle more actions menu
    function toggleMoreActionsMenu() {
      moreActionsMenu.classList.toggle('active');
      sortByMenu.classList.remove('active');
    }
    
    // Hide more actions menu
    function hideMoreActionsMenu() {
      moreActionsMenu.classList.remove('active');
    }
    
    // Show sort by modal
    function showSortByModal() {
      hideMoreActionsMenu();
      sortByModal.classList.add('active');
    }
    
    // Hide sort by modal
    function hideSortByModal() {
      sortByModal.classList.remove('active');
    }
    
    // Show status modal
    async function showStatusModal() {
      hideMoreActionsMenu();
      
      try {
        const files = await getAllFiles();
        const fileTypes = {};
        let totalSize = 0;
        
        // Calculate file type distribution
        files.forEach(file => {
          fileTypes[file.type] = (fileTypes[file.type] || 0) + 1;
          totalSize += file.size || 0;
        });
        
        // Sort by count (descending)
        const sortedTypes = Object.entries(fileTypes).sort((a, b) => b[1] - a[1]);
        
        // Generate status HTML
        let statusHTML = '';
        
        // Total storage
        statusHTML += `
          <div class="status-item">
            <div class="status-header">
              <span>Total Storage</span>
              <span>${formatFileSize(totalSize)}</span>
            </div>
            <div class="status-bar">
              <div class="status-progress" style="width: 100%"></div>
            </div>
          </div>
        `;
        
        // File type distribution
        sortedTypes.forEach(([type, count]) => {
          const percentage = Math.round((count / files.length) * 100);
          const icon = getFileIcon(type);
          
          statusHTML += `
            <div class="status-item">
              <div class="status-header">
                <span><i class="fas ${icon}"></i> ${type.split('/')[1] || type}</span>
                <span>${percentage}% (${count})</span>
              </div>
              <div class="status-bar">
                <div class="status-progress" style="width: ${percentage}%"></div>
              </div>
            </div>
          `;
        });
        
        statusContainer.innerHTML = statusHTML;
        statusModal.classList.add('active');
      } catch (error) {
        console.error('Error loading status:', error);
        alert('Failed to load storage status. Please try again.');
      }
    }
    
    // Hide status modal
    function hideStatusModal() {
      statusModal.classList.remove('active');
    }
    
    // Show recycle bin modal
    async function showRecycleBinModal() {
      hideMoreActionsMenu();
      
      try {
        const deletedItems = await getAllDeletedItems();
        
        if (deletedItems.length === 0) {
          recycleBinList.style.display = 'none';
          recycleBinEmpty.style.display = 'block';
        } else {
          recycleBinList.style.display = 'block';
          recycleBinEmpty.style.display = 'none';
          
          let itemsHTML = '';
          
          deletedItems.forEach(item => {
            itemsHTML += `
              <div class="list-item" data-id="${item.id}" data-type="${item.type}">
                <div class="list-item-name">
                  <i class="fas ${item.type === 'folder' ? 'fa-folder' : getFileIcon(item.fileType)} list-item-icon"></i>
                  <span>${item.name}</span>
                </div>
                <div>${item.originalPath}</div>
                <div>${formatDate(item.deletedAt)}</div>
                <div>${item.type === 'folder' ? '--' : formatFileSize(item.size)}</div>
              </div>
            `;
          });
          
          recycleBinItemsContainer.innerHTML = itemsHTML;
          
          // Add click event to restore items
          document.querySelectorAll('#recycleBinItemsContainer .list-item').forEach(item => {
            item.addEventListener('click', () => {
              const id = item.getAttribute('data-id');
              const type = item.getAttribute('data-type');
              restoreItem(id, type);
            });
          });
        }
        
        recycleBinModal.classList.add('active');
      } catch (error) {
        console.error('Error loading recycle bin:', error);
        alert('Failed to load recycle bin. Please try again.');
      }
    }
    
    // Hide recycle bin modal
    function hideRecycleBinModal() {
      recycleBinModal.classList.remove('active');
    }
    
    // Empty recycle bin
    async function emptyRecycleBin() {
      if (confirm('Are you sure you want to permanently delete all items in the Recycle Bin? This action cannot be undone.')) {
        try {
          const transaction = db.transaction(['recycleBin'], 'readwrite');
          const store = transaction.objectStore('recycleBin');
          const request = store.clear();
          
          request.onsuccess = () => {
            showRecycleBinModal(); // Refresh the view
          };
        } catch (error) {
          console.error('Error emptying recycle bin:', error);
          alert('Failed to empty recycle bin. Please try again.');
        }
      }
    }
    
    // Restore item from recycle bin
    async function restoreItem(id, type) {
      try {
        const transaction = db.transaction(['recycleBin', type === 'folder' ? 'folders' : 'files'], 'readwrite');
        const recycleStore = transaction.objectStore('recycleBin');
        const targetStore = transaction.objectStore(type === 'folder' ? 'folders' : 'files');
        
        // Get the item from recycle bin
        const getRequest = recycleStore.get(id);
        
        getRequest.onsuccess = (event) => {
          const item = event.target.result;
          
          if (!item) {
            alert('Item not found in recycle bin');
            return;
          }
          
          // Restore the item to its original location
          const restoreRequest = targetStore.put(item.originalData);
          
          restoreRequest.onsuccess = () => {
            // Remove from recycle bin
            recycleStore.delete(id);
            
            // Refresh the view
            showRecycleBinModal();
            
            // If restoring to current folder, refresh the view
            if (item.originalData.folderId === currentFolderId || 
                (type === 'folder' && item.originalData.parentId === currentFolderId)) {
              loadCurrentFolder();
            }
          };
        };
      } catch (error) {
        console.error('Error restoring item:', error);
        alert('Failed to restore item. Please try again.');
      }
    }
    
    // Switch between grid and list view
    function switchView(mode) {
      viewMode = mode;
      
      if (mode === 'grid') {
        gridViewBtn.classList.add('active');
        listViewBtn.classList.remove('active');
        itemsGrid.style.display = 'grid';
        itemsList.classList.remove('active');
      } else {
        gridViewBtn.classList.remove('active');
        listViewBtn.classList.add('active');
        itemsGrid.style.display = 'none';
        itemsList.classList.add('active');
      }
      
      localStorage.setItem('viewMode', mode);
    }
    
    // Load current folder contents
    async function loadCurrentFolder() {
      try {
        const folders = await getFoldersInCurrentFolder();
        const files = await getFilesInCurrentFolder();
        
        // Sort items
        const [sortedFolders, sortedFiles] = sortItems(folders, files);
        
        renderItems(sortedFolders, sortedFiles);
        updatePathBreadcrumbs();
        updateUI();
      } catch (error) {
        console.error('Error loading folder:', error);
        alert('Failed to load folder contents. Please try again.');
      }
    }
    
    // Sort items based on current sortBy setting
    function sortItems(folders, files) {
      const [field, order] = sortBy.split('-');
      
      const sortFn = (a, b) => {
        let valA, valB;
        
        switch (field) {
          case 'name':
            valA = a.name.toLowerCase();
            valB = b.name.toLowerCase();
            return order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          
          case 'date':
            valA = new Date(a.updatedAt || a.createdAt);
            valB = new Date(b.updatedAt || b.createdAt);
            return order === 'asc' ? valA - valB : valB - valA;
          
          case 'size':
            // Folders don't have size, so we sort them first
            if (a.type === 'folder' && b.type !== 'folder') return -1;
            if (a.type !== 'folder' && b.type === 'folder') return 1;
            if (a.type === 'folder' && b.type === 'folder') {
              return order === 'asc' ? 
                a.name.toLowerCase().localeCompare(b.name.toLowerCase()) : 
                b.name.toLowerCase().localeCompare(a.name.toLowerCase());
            }
            
            valA = a.size || 0;
            valB = b.size || 0;
            return order === 'asc' ? valA - valB : valB - valA;
          
          default:
            return 0;
        }
      };
      
      return [
        [...folders].sort(sortFn),
        [...files].sort(sortFn)
      ];
    }
    
    // Render items in current view
    function renderItems(folders, files) {
      if (folders.length === 0 && files.length === 0) {
        emptyState.style.display = 'block';
        itemsGrid.innerHTML = '';
        listItemsContainer.innerHTML = '';
        return;
      }
      
      emptyState.style.display = 'none';
      
      // Render grid view
      let gridHTML = '';
      
      // Add folders to grid
      folders.forEach(folder => {
        gridHTML += `
          <div class="item-card" data-id="${folder.id}" data-type="folder">
            <div class="item-icon">
              <i class="fas ${fileIcons.folder}"></i>
            </div>
            <div class="item-details">
              <div class="item-name" title="${folder.name}">${folder.name}</div>
              <div class="item-meta">
                <span>Folder</span>
                <span>${formatDate(folder.updatedAt || folder.createdAt)}</span>
              </div>
            </div>
            <div class="item-actions">
              <i class="fas fa-ellipsis-v"></i>
            </div>
          </div>
        `;
      });
      
      // Add files to grid
      files.forEach(file => {
        const icon = getFileIcon(file.type);
        const isImage = file.type.startsWith('image/');
        
        gridHTML += `
          <div class="item-card" data-id="${file.id}" data-type="file">
            ${isImage ? 
              `<img src="${URL.createObjectURL(new Blob([file.data], { type: file.type }))}" class="item-thumbnail" alt="${file.name}">` : 
              `<div class="item-icon">
                <i class="fas ${icon}"></i>
              </div>`
            }
            <div class="item-details">
              <div class="item-name" title="${file.name}">${file.name}</div>
              <div class="item-meta">
                <span>${formatFileSize(file.size)}</span>
                <span>${formatDate(file.updatedAt || file.createdAt)}</span>
              </div>
            </div>
            <div class="item-actions">
              <i class="fas fa-ellipsis-v"></i>
            </div>
          </div>
        `;
      });
      
      itemsGrid.innerHTML = gridHTML;
      
      // Render list view
      let listHTML = '';
      
      // Add folders to list
      folders.forEach(folder => {
        listHTML += `
          <div class="list-item" data-id="${folder.id}" data-type="folder">
            <div class="list-item-name">
              <i class="fas ${fileIcons.folder} list-item-icon"></i>
              <span>${folder.name}</span>
            </div>
            <div>--</div>
            <div>Folder</div>
            <div>${formatDate(folder.updatedAt || folder.createdAt)}</div>
          </div>
        `;
      });
      
      // Add files to list
      files.forEach(file => {
        const icon = getFileIcon(file.type);
        
        listHTML += `
          <div class="list-item" data-id="${file.id}" data-type="file">
            <div class="list-item-name">
              <i class="fas ${icon} list-item-icon"></i>
              <span>${file.name}</span>
            </div>
            <div>${formatFileSize(file.size)}</div>
            <div>${file.type}</div>
            <div>${formatDate(file.updatedAt || file.createdAt)}</div>
          </div>
        `;
      });
      
      listItemsContainer.innerHTML = listHTML;
      
      // Setup item click handlers
      setupItemClickHandlers();
    }
    
    // Setup click handlers for items
    function setupItemClickHandlers() {
      // Grid view items
      document.querySelectorAll('.item-card').forEach(item => {
        const id = item.getAttribute('data-id');
        const type = item.getAttribute('data-type');
        
        // Item click
        item.addEventListener('click', (e) => {
          // Don't navigate if clicking on actions or in select mode
          if (e.target.closest('.item-actions') || isSelectMode) {
            return;
          }
          
          if (type === 'folder') {
            navigateToFolder(id);
          } else {
            previewFile(id);
          }
        });
        
        // Item long press/right click for selection
        let pressTimer;
        
        item.addEventListener('mousedown', () => {
          pressTimer = setTimeout(() => {
            toggleSelectMode(true);
            toggleItemSelection(item, id, type);
          }, 800);
        });
        
        item.addEventListener('mouseup', () => {
          clearTimeout(pressTimer);
        });
        
        item.addEventListener('mouseleave', () => {
          clearTimeout(pressTimer);
        });
        
        item.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          toggleSelectMode(true);
          toggleItemSelection(item, id, type);
        });
        
        // Actions click
        const actionsBtn = item.querySelector('.item-actions');
        if (actionsBtn) {
          actionsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showItemContextMenu(id, type, e);
          });
        }
      });
      
      // List view items
      document.querySelectorAll('.list-item').forEach(item => {
        const id = item.getAttribute('data-id');
        const type = item.getAttribute('data-type');
        
        // Item click
        item.addEventListener('click', (e) => {
          if (isSelectMode) {
            toggleItemSelection(item, id, type);
          } else {
            if (type === 'folder') {
              navigateToFolder(id);
            } else {
              previewFile(id);
            }
          }
        });
        
        // Item long press/right click for selection
        let pressTimer;
        
        item.addEventListener('mousedown', () => {
          pressTimer = setTimeout(() => {
            toggleSelectMode(true);
            toggleItemSelection(item, id, type);
          }, 800);
        });
        
        item.addEventListener('mouseup', () => {
          clearTimeout(pressTimer);
        });
        
        item.addEventListener('mouseleave', () => {
          clearTimeout(pressTimer);
        });
        
        item.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          toggleSelectMode(true);
          toggleItemSelection(item, id, type);
        });
      });
    }
    
    // Show context menu for item
    function showItemContextMenu(id, type, event) {
      // Create context menu
      const menu = document.createElement('div');
      menu.className = 'dropdown-menu';
      menu.style.position = 'fixed';
      menu.style.left = `${event.clientX}px`;
      menu.style.top = `${event.clientY}px`;
      
      menu.innerHTML = `
        <div class="dropdown-item" data-action="open">
          <i class="fas fa-folder-open"></i>
          <span>Open</span>
        </div>
        <div class="dropdown-item" data-action="copy">
          <i class="fas fa-copy"></i>
          <span>Copy</span>
        </div>
        <div class="dropdown-item" data-action="properties">
          <i class="fas fa-info-circle"></i>
          <span>Properties</span>
        </div>
        <div class="dropdown-item" data-action="delete">
          <i class="fas fa-trash"></i>
          <span>Delete</span>
        </div>
      `;
      
      document.body.appendChild(menu);
      
      // Handle menu clicks
      menu.addEventListener('click', (e) => {
        const action = e.target.closest('.dropdown-item')?.getAttribute('data-action');
        
        if (action) {
          switch (action) {
            case 'open':
              if (type === 'folder') {
                navigateToFolder(id);
              } else {
                previewFile(id);
              }
              break;
            case 'copy':
              copyItems([{ id, type }]);
              break;
            case 'properties':
              showProperties(id, type);
              break;
            case 'delete':
              deleteItems([{ id, type }]);
              break;
          }
        }
        
        menu.remove();
      });
      
      // Close menu when clicking outside
      const closeMenu = () => {
        menu.remove();
        document.removeEventListener('click', closeMenu);
      };
      
      setTimeout(() => {
        document.addEventListener('click', closeMenu);
      }, 100);
    }
    
    // Toggle select mode
    function toggleSelectMode(enable) {
      isSelectMode = enable !== undefined ? enable : !isSelectMode;
      
      if (isSelectMode) {
        document.body.classList.add('select-mode');
        selectionBar.classList.add('active');
      } else {
        document.body.classList.remove('select-mode');
        selectionBar.classList.remove('active');
        clearSelection();
      }
    }
    
    // Toggle item selection
    function toggleItemSelection(item, id, type) {
      const index = selectedItems.findIndex(i => i.id === id && i.type === type);
      
      if (index === -1) {
        selectedItems.push({ id, type });
        item.classList.add('selected');
      } else {
        selectedItems.splice(index, 1);
        item.classList.remove('selected');
      }
      
      updateSelectionCount();
      
      // Exit select mode if no items are selected
      if (selectedItems.length === 0) {
        toggleSelectMode(false);
      }
    }
    
    // Clear selection
    function clearSelection() {
      selectedItems = [];
      document.querySelectorAll('.item-card.selected, .list-item.selected').forEach(item => {
        item.classList.remove('selected');
      });
      updateSelectionCount();
    }
    
    // Update selection count
    function updateSelectionCount() {
      selectionCount.textContent = `${selectedItems.length} selected`;
    }
    
    // Copy selected items
    function copySelectedItems() {
      copyItems(selectedItems);
      toggleSelectMode(false);
    }
    
    // Copy items
    function copyItems(items) {
      copiedItems = [...items];
      pasteFabBtn.style.display = 'flex';
      toggleSelectMode(false);
    }
    
    // Paste items
    async function pasteItems() {
      if (copiedItems.length === 0) return;
      
      try {
        for (const item of copiedItems) {
          if (item.type === 'folder') {
            await copyFolder(item.id, currentFolderId);
          } else {
            await copyFile(item.id, currentFolderId);
          }
        }
        
        loadCurrentFolder();
        pasteFabBtn.style.display = 'none';
        copiedItems = [];
      } catch (error) {
        console.error('Error pasting items:', error);
        alert('Failed to paste items. Please try again.');
      }
    }
    
    // Delete selected items
    function deleteSelectedItems() {
      deleteItems(selectedItems);
      toggleSelectMode(false);
    }
    
    // Delete items
    async function deleteItems(items) {
      if (items.length === 0) return;
      
      if (!confirm(`Are you sure you want to move ${items.length} item(s) to the Recycle Bin?`)) {
        return;
      }
      
      try {
        for (const item of items) {
          if (item.type === 'folder') {
            await moveFolderToRecycleBin(item.id);
          } else {
            await moveFileToRecycleBin(item.id);
          }
        }
        
        loadCurrentFolder();
      } catch (error) {
        console.error('Error deleting items:', error);
        alert('Failed to delete items. Please try again.');
      }
    }
    
    // Move folder to recycle bin
    async function moveFolderToRecycleBin(folderId) {
      const transaction = db.transaction(['folders', 'recycleBin'], 'readwrite');
      const foldersStore = transaction.objectStore('folders');
      const recycleStore = transaction.objectStore('recycleBin');
      
      // Get the folder
      const folder = await new Promise((resolve, reject) => {
        const request = foldersStore.get(folderId);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
      
      if (!folder) return;
      
      // Add to recycle bin
      await new Promise((resolve, reject) => {
        const request = recycleStore.put({
          id: folder.id,
          name: folder.name,
          type: 'folder',
          originalPath: folder.path,
          deletedAt: new Date().toISOString(),
          originalData: folder
        });
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
      
      // Delete from folders
      await new Promise((resolve, reject) => {
        const request = foldersStore.delete(folder.id);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }
    
    // Move file to recycle bin
    async function moveFileToRecycleBin(fileId) {
      const transaction = db.transaction(['files', 'recycleBin'], 'readwrite');
      const filesStore = transaction.objectStore('files');
      const recycleStore = transaction.objectStore('recycleBin');
      
      // Get the file
      const file = await new Promise((resolve, reject) => {
        const request = filesStore.get(fileId);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
      
      if (!file) return;
      
      // Add to recycle bin
      await new Promise((resolve, reject) => {
        const request = recycleStore.put({
          id: file.id,
          name: file.name,
          type: 'file',
          fileType: file.type,
          size: file.size,
          originalPath: file.path || currentPath,
          deletedAt: new Date().toISOString(),
          originalData: file
        });
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
      
      // Delete from files
      await new Promise((resolve, reject) => {
        const request = filesStore.delete(file.id);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }
    
    // Get all deleted items
    function getAllDeletedItems() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['recycleBin'], 'readonly');
        const store = transaction.objectStore('recycleBin');
        const request = store.getAll();
        
        request.onsuccess = () => resolve(request.result || []);
        request.onerror = () => reject(request.error);
      });
    }
    
    // Copy folder
    async function copyFolder(sourceId, targetFolderId) {
      const transaction = db.transaction(['folders'], 'readwrite');
      const store = transaction.objectStore('folders');
      
      // Get the source folder
      const sourceFolder = await new Promise((resolve, reject) => {
        const request = store.get(sourceId);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
      
      if (!sourceFolder) return;
      
      // Create a new folder with the same properties
      const newFolder = {
        ...sourceFolder,
        id: generateId(),
        parentId: targetFolderId,
        name: getUniqueName(sourceFolder.name, 'folders', targetFolderId),
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      // Save the new folder
      await new Promise((resolve, reject) => {
        const request = store.put(newFolder);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
      
      // Recursively copy contents if needed
      // (This would require additional implementation for nested folders)
    }
    
    // Copy file
    async function copyFile(sourceId, targetFolderId) {
      const transaction = db.transaction(['files'], 'readwrite');
      const store = transaction.objectStore('files');
      
      // Get the source file
      const sourceFile = await new Promise((resolve, reject) => {
        const request = store.get(sourceId);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
      
      if (!sourceFile) return;
      
      // Create a new file with the same properties
      const newFile = {
        ...sourceFile,
        id: generateId(),
        folderId: targetFolderId,
        name: getUniqueName(sourceFile.name, 'files', targetFolderId),
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      // Save the new file
      await new Promise((resolve, reject) => {
        const request = store.put(newFile);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }
    
    // Get unique name for copied/moved items
    async function getUniqueName(baseName, storeName, parentId) {
      const items = storeName === 'folders' ? 
        await getFoldersInFolder(parentId) : 
        await getFilesInFolder(parentId);
      
      const existingNames = items.map(item => item.name);
      
      if (!existingNames.includes(baseName)) {
        return baseName;
      }
      
      let counter = 1;
      let newName = '';
      
      do {
        const extIndex = baseName.lastIndexOf('.');
        if (extIndex === -1 || storeName === 'folders') {
          newName = `${baseName} (${counter})`;
        } else {
          const name = baseName.substring(0, extIndex);
          const ext = baseName.substring(extIndex);
          newName = `${name} (${counter})${ext}`;
        }
        counter++;
      } while (existingNames.includes(newName));
      
      return newName;
    }
    
    // Update UI based on current state
    function updateUI() {
      // Show/hide back button
      if (currentFolderId === 'root') {
        navBackBtn.classList.remove('active');
      } else {
        navBackBtn.classList.add('active');
      }
      
      // Update title
      if (currentFolderId === 'root') {
        currentFolderTitle.textContent = 'My Files';
      } else {
        getFolder(currentFolderId).then(folder => {
          if (folder) {
            currentFolderTitle.textContent = folder.name;
          }
        });
      }
      
      // Hide paste button if nothing is copied
      if (copiedItems.length === 0) {
        pasteFabBtn.style.display = 'none';
      }
    }
    
    // Update path breadcrumbs
    async function updatePathBreadcrumbs() {
      if (currentFolderId === 'root') {
        pathBreadcrumbs.innerHTML = `
          <div class="breadcrumb-item active" data-path="/">Home</div>
        `;
        return;
      }
      
      const pathParts = [];
      let folderId = currentFolderId;
      
      // Build path parts by traversing up the folder hierarchy
      while (folderId && folderId !== 'root') {
        const folder = await getFolder(folderId);
        if (!folder) break;
        
        pathParts.unshift({
          id: folder.id,
          name: folder.name,
          path: folder.path
        });
        
        folderId = folder.parentId;
      }
      
      // Add root folder
      pathParts.unshift({
        id: 'root',
        name: 'Home',
        path: '/'
      });
      
      // Render breadcrumbs
      let breadcrumbsHTML = '';
      
      pathParts.forEach((part, index) => {
        const isLast = index === pathParts.length - 1;
        breadcrumbsHTML += `
          <div class="breadcrumb-item ${isLast ? 'active' : ''}" data-id="${part.id}" data-path="${part.path}">
            ${part.name}
          </div>
        `;
      });
      
      pathBreadcrumbs.innerHTML = breadcrumbsHTML;
      
      // Add click handlers
      document.querySelectorAll('.breadcrumb-item:not(.active)').forEach(item => {
        item.addEventListener('click', () => {
          const id = item.getAttribute('data-id');
          navigateToFolder(id);
        });
      });
    }
    
    // Navigate to folder
    function navigateToFolder(folderId) {
      currentFolderId = folderId;
      loadCurrentFolder();
    }
    
    // Navigate to parent folder
    async function navigateToParentFolder() {
      if (currentFolderId === 'root') return;
      
      const folder = await getFolder(currentFolderId);
      if (folder && folder.parentId) {
        currentFolderId = folder.parentId;
        loadCurrentFolder();
      } else {
        currentFolderId = 'root';
        loadCurrentFolder();
      }
    }
    
    // Preview file
    async function previewFile(fileId) {
      try {
        const file = await getFile(fileId);
        if (!file) {
          alert('File not found');
          return;
        }
        
        previewTitle.textContent = file.name;
        
        // Clear previous content
        previewContent.innerHTML = '';
        
        // Create a blob URL for the file
        const blob = new Blob([file.data], { type: file.type });
        const blobUrl = URL.createObjectURL(blob);
        
        // Handle different file types
        if (file.type.startsWith('image/')) {
          // Image preview
          const img = document.createElement('img');
          img.src = blobUrl;
          img.className = 'preview-image';
          img.alt = file.name;
          previewContent.appendChild(img);
        } else if (file.type === 'text/plain' || file.type.startsWith('text/')) {
          // Text file preview
          const text = await blob.text();
          const textarea = document.createElement('textarea');
          textarea.className = 'preview-text';
          textarea.readOnly = true;
          textarea.value = text;
          previewContent.appendChild(textarea);
        } else {
          // Unsupported file type
          const unsupportedDiv = document.createElement('div');
          unsupportedDiv.className = 'preview-unsupported';
          unsupportedDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <h3>File type not supported for preview</h3>
            <p>This file type cannot be previewed in the app. Please download the file to view it.</p>
          `;
          previewContent.appendChild(unsupportedDiv);
        }
        
        // Set up download button
        downloadPreviewBtn.onclick = () => {
          downloadFile(fileId);
          hideFilePreviewModal();
        };
        
        // Set up copy button
        copyPreviewBtn.onclick = () => {
          copyItems([{ id: fileId, type: 'file' }]);
          hideFilePreviewModal();
        };
        
        // Set up properties button
        propertiesPreviewBtn.onclick = () => {
          showProperties(fileId, 'file');
        };
        
        // Set up delete button
        deletePreviewBtn.onclick = () => {
          deleteItems([{ id: fileId, type: 'file' }]);
          hideFilePreviewModal();
        };
        
        // Show the modal
        filePreviewModal.classList.add('active');
      } catch (error) {
        console.error('Error previewing file:', error);
        alert('Failed to preview file. Please try again.');
      }
    }
    
    // Show properties for item
    async function showProperties(id, type) {
      try {
        let item;
        
        if (type === 'folder') {
          item = await getFolder(id);
        } else {
          item = await getFile(id);
        }
        
        if (!item) {
          alert('Item not found');
          return;
        }
        
        // Clear previous properties
        propertiesGrid.innerHTML = '';
        
        // Add properties based on item type
        if (type === 'folder') {
          propertiesGrid.innerHTML = `
            <div class="property-name">Name:</div>
            <div class="property-value">${item.name}</div>
            <div class="property-name">Type:</div>
            <div class="property-value">Folder</div>
            <div class="property-name">Location:</div>
            <div class="property-value">${item.path}</div>
            <div class="property-name">Created:</div>
            <div class="property-value">${formatDate(item.createdAt)}</div>
            <div class="property-name">Modified:</div>
            <div class="property-value">${formatDate(item.updatedAt || item.createdAt)}</div>
          `;
        } else {
          propertiesGrid.innerHTML = `
            <div class="property-name">Name:</div>
            <div class="property-value">${item.name}</div>
            <div class="property-name">Type:</div>
            <div class="property-value">${item.type}</div>
            <div class="property-name">Size:</div>
            <div class="property-value">${formatFileSize(item.size)}</div>
            <div class="property-name">Location:</div>
            <div class="property-value">${item.path || currentPath}</div>
            <div class="property-name">Created:</div>
            <div class="property-value">${formatDate(item.createdAt)}</div>
            <div class="property-name">Modified:</div>
            <div class="property-value">${formatDate(item.updatedAt || item.createdAt)}</div>
          `;
        }
        
        // Show the modal
        propertiesModal.classList.add('active');
        
        // Hide other modals if they're open
        hideFilePreviewModal();
      } catch (error) {
        console.error('Error showing properties:', error);
        alert('Failed to load properties. Please try again.');
      }
    }
    
    // Show properties for previewed file
    function showPropertiesForPreviewedFile() {
      const fileId = downloadPreviewBtn.getAttribute('data-file-id');
      showProperties(fileId, 'file');
    }
    
    // Download file
    async function downloadFile(fileId) {
      try {
        const file = await getFile(fileId);
        if (!file) {
          alert('File not found');
          return;
        }
        
        const blob = new Blob([file.data], { type: file.type });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = file.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        // Clean up
        setTimeout(() => {
          URL.revokeObjectURL(url);
        }, 100);
      } catch (error) {
        console.error('Error downloading file:', error);
        alert('Failed to download file. Please try again.');
      }
    }
    
    // Download previewed file
    function downloadPreviewedFile() {
      const fileId = downloadPreviewBtn.getAttribute('data-file-id');
      downloadFile(fileId);
    }
    
    // Copy previewed file
    function copyPreviewedFile() {
      const fileId = copyPreviewBtn.getAttribute('data-file-id');
      copyItems([{ id: fileId, type: 'file' }]);
    }
    
    // Delete previewed file
    function deletePreviewedFile() {
      const fileId = deletePreviewBtn.getAttribute('data-file-id');
      deleteItems([{ id: fileId, type: 'file' }]);
    }
    
    // Toggle FAB menu
    function toggleFabMenu() {
      fabMenu.classList.toggle('active');
      fabMainBtn.classList.toggle('active');
    }
    
    // Show upload modal
    function showUploadModal() {
      toggleFabMenu();
      uploadFileName.value = '';
      uploadFileInput.value = '';
      uploadModal.classList.add('active');
    }
    
    // Hide upload modal
    function hideUploadModal() {
      uploadModal.classList.remove('active');
    }
    
    // Upload file
    async function uploadFile() {
      const file = uploadFileInput.files[0];
      if (!file) {
        alert('Please select a file to upload');
        return;
      }
      
      const fileName = uploadFileName.value.trim() || file.name;
      
      try {
        const fileData = await readFileAsArrayBuffer(file);
        
        const newFile = {
          id: generateId(),
          name: fileName,
          type: file.type,
          size: file.size,
          data: fileData,
          folderId: currentFolderId,
          path: currentPath,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        await saveFile(newFile);
        hideUploadModal();
        loadCurrentFolder();
      } catch (error) {
        console.error('Error uploading file:', error);
        alert('Failed to upload file. Please try again.');
      }
    }
    
    // Show new folder modal
    function showNewFolderModal() {
      toggleFabMenu();
      folderName.value = 'New folder';
      newFolderModal.classList.add('active');
      folderName.focus();
      folderName.select();
    }
    
    // Hide new folder modal
    function hideNewFolderModal() {
      newFolderModal.classList.remove('active');
    }
    
    // Create new folder
    async function createNewFolder() {
      const name = folderName.value.trim();
      if (!name) {
        alert('Please enter a folder name');
        return;
      }
      
      try {
        // Check if folder name already exists
        const folders = await getFoldersInCurrentFolder();
        const exists = folders.some(folder => folder.name === name);
        
        let folderNameToUse = name;
        if (exists) {
          // Find a unique name by appending a number
          let counter = 1;
          while (folders.some(folder => folder.name === `${name} (${counter})`)) {
            counter++;
          }
          folderNameToUse = `${name} (${counter})`;
        }
        
        const newFolder = {
          id: generateId(),
          name: folderNameToUse,
          parentId: currentFolderId,
          path: currentPath + folderNameToUse + '/',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        await saveFolder(newFolder);
        hideNewFolderModal();
        loadCurrentFolder();
      } catch (error) {
        console.error('Error creating folder:', error);
        alert('Failed to create folder. Please try again.');
      }
    }
    
    // Hide file preview modal
    function hideFilePreviewModal() {
      filePreviewModal.classList.remove('active');
      
      // Clean up blob URLs
      const images = previewContent.querySelectorAll('img');
      images.forEach(img => {
        if (img.src.startsWith('blob:')) {
          URL.revokeObjectURL(img.src);
        }
      });
    }
    
    // Hide properties modal
    function hidePropertiesModal() {
      propertiesModal.classList.remove('active');
    }
    
    // Get file icon based on type
    function getFileIcon(type) {
      return fileIcons[type] || fileIcons.default;
    }
    
    // Format file size
    function formatFileSize(bytes) {
      if (bytes === 0 || bytes === undefined) return '0 Bytes';
      
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Format date
    function formatDate(dateString) {
      if (!dateString) return '';
      
      const date = new Date(dateString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    // Generate ID
    function generateId() {
      return Date.now().toString() + Math.random().toString(36).substr(2, 9);
    }
    
    // Read file as ArrayBuffer
    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error);
        reader.readAsArrayBuffer(file);
      });
    }
    
    // Debounce function
    function debounce(func, wait) {
      let timeout;
      return function() {
        const context = this, args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          func.apply(context, args);
        }, wait);
      };
    }
    
    // Database operations
    function getFoldersInCurrentFolder() {
      return getFoldersInFolder(currentFolderId);
    }
    
    function getFoldersInFolder(folderId) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['folders'], 'readonly');
        const store = transaction.objectStore('folders');
        const index = store.index('parentId');
        const request = index.getAll(folderId || 'root');
        
        request.onsuccess = () => resolve(request.result || []);
        request.onerror = () => reject(request.error);
      });
    }
    
    function getFilesInCurrentFolder() {
      return getFilesInFolder(currentFolderId);
    }
    
    function getFilesInFolder(folderId) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['files'], 'readonly');
        const store = transaction.objectStore('files');
        const index = store.index('folderId');
        const request = index.getAll(folderId || 'root');
        
        request.onsuccess = () => resolve(request.result || []);
        request.onerror = () => reject(request.error);
      });
    }
    
    function getAllFolders() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['folders'], 'readonly');
        const store = transaction.objectStore('folders');
        const request = store.getAll();
        
        request.onsuccess = () => resolve(request.result || []);
        request.onerror = () => reject(request.error);
      });
    }
    
    function getAllFiles() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['files'], 'readonly');
        const store = transaction.objectStore('files');
        const request = store.getAll();
        
        request.onsuccess = () => resolve(request.result || []);
        request.onerror = () => reject(request.error);
      });
    }
    
    function getFolder(folderId) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['folders'], 'readonly');
        const store = transaction.objectStore('folders');
        const request = store.get(folderId);
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }
    
    function getFile(fileId) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['files'], 'readonly');
        const store = transaction.objectStore('files');
        const request = store.get(fileId);
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }
    
    function saveFolder(folder) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['folders'], 'readwrite');
        const store = transaction.objectStore('folders');
        const request = store.put(folder);
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }
    
    function saveFile(file) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['files'], 'readwrite');
        const store = transaction.objectStore('files');
        const request = store.put(file);
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }
    
    // Initialize the app
    initApp();
  </script>
</body>
</html>