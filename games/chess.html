<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Play chess online for free at Toolpix Games! Enjoy single-player mode against a smart AI bot or challenge friends in two-player mode. Learn how to play chess with our easy guide. No downloads needed, playable on any device.">
  <meta name="keywords" content="play chess online, free chess game, online chess, chess against computer, two-player chess, chess guide, learn chess, chess rules, chess strategy, chess for beginners, chess board, online chess game, chess AI, Toolpix Games">
  <meta name="author" content="Toolpix Games">
  <meta name="robots" content="index, follow">
  <title>Play Chess Online Free - Toolpix Games</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Arial, sans-serif;
    }

    body {
      background-color: #1c2526;
      color: #e0e0e0;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .welcome-screen {
      text-align: center;
      padding: 20px;
      background-color: #2d3839;
      margin: 20px;
      border-radius: 15px;
      animation: fadeIn 1s ease-in-out;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    .welcome-screen::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(212, 163, 115, 0.2) 0%, transparent 70%);
      opacity: 0.5;
      z-index: 0;
    }

    .welcome-screen h1, .welcome-screen h2, .welcome-screen h3, .welcome-screen .mode-selection, .welcome-screen .difficulty-selection, .welcome-screen .home-link-container, .welcome-screen .guide-section {
      position: relative;
      z-index: 1;
    }

    .welcome-screen h1 {
      font-size: 36px;
      margin-bottom: 20px;
      animation: bounceIn 1s ease;
    }

    .welcome-screen h2 {
      font-size: 28px;
      margin: 20px 0;
    }

    .welcome-screen h3 {
      font-size: 24px;
      margin-bottom: 20px;
    }

    .home-link-container {
      position: absolute;
      top: 10px;
      left: 10px;
    }

    .home-link {
      background-color: #d4a373;
      color: #1c2526;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      text-decoration: none;
      transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .home-link::before {
      content: 'üè†';
      font-size: 18px;
    }

    .home-link:hover {
      transform: scale(1.05);
      background-color: #e0c4a8;
      box-shadow: 0 6px 15px rgba(212, 163, 115, 0.6);
    }

    .mode-selection {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .mode-button, .difficulty-button, .back-button, .how-to-play-button {
      background-color: #3a4b4c;
      color: #e0e0e0;
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      cursor: pointer;
      transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
      min-width: 200px;
    }

    .how-to-play-button {
      background-color: #d4a373;
      color: #1c2526;
      margin-top: 20px;
    }

    .mode-button:hover, .difficulty-button:hover, .back-button:hover, .how-to-play-button:hover {
      transform: scale(1.05);
      background-color: #d4a373;
      box-shadow: 0 6px 15px rgba(212, 163, 115, 0.6);
    }

    .difficulty-selection {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      animation: fadeIn 0.5s ease-in-out;
    }

    .difficulty-selection select {
      background-color: #3a4b4c;
      color: #e0e0e0;
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      cursor: pointer;
      transition: transform 0.3s ease, background-color 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
      width: 200px;
      text-align: center;
    }

    .guide-section {
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background-color: #3a4b4c;
      border-radius: 10px;
      text-align: left;
    }

    .guide-section ul, .guide-section ol {
      margin-left: 20px;
      margin-bottom: 20px;
    }

    .guide-section li {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    .game-section {
      display: none;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      background-color: #1c2526;
      position: relative;
    }

    .game-section .back-button-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }

    .chessboard-container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-grow: 1;
      padding: 10px;
      overflow: hidden;
      transition: transform 0.3s ease;
    }

    .chessboard-container:hover {
      transform: scale(1.02);
    }

    .chessboard {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 0;
      margin: 0 auto;
      width: 100%;
      max-width: 100vmin;
      aspect-ratio: 1/1;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.6);
      border: 5px solid #3a4b4c;
    }

    @media (min-width: 769px) {
      .chessboard {
        max-width: 70vmin;
      }
    }

    .cell {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      aspect-ratio: 1/1;
    }

    .cell.light {
      background-color: #f0d9b5;
    }

    .cell.dark {
      background-color: #b58863;
    }

    .cell:hover {
      transform: scale(1.05);
      box-shadow: 0 0 10px rgba(212, 163, 115, 0.5);
    }

    .cell img {
      width: 80%;
      height: 80%;
      object-fit: contain;
      transition: transform 0.3s ease;
    }

    .cell.selected {
      box-shadow: 0 0 15px #d4a373 inset;
      transform: scale(1.1);
    }

    .cell.possible-move::after {
      content: '';
      position: absolute;
      width: 25%;
      height: 25%;
      background-color: rgba(212, 163, 115, 0.5);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    .game-info {
      font-size: 20px;
      font-weight: bold;
      margin: 10px 0;
      text-align: center;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }

    .ad-banner {
      height: 60px;
      width: 100%;
      background-color: #2d3839;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 16px;
      color: #e0e0e0;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
    }

    .welcome-screen .ad-banner {
      margin-top: auto;
    }

    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #2d3839;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.7);
      text-align: center;
      z-index: 2000;
      animation: popIn 0.4s ease;
      width: 90%;
      max-width: 400px;
    }

    .popup h3 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #d4a373;
    }

    .popup-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .popup-button {
      background-color: #d4a373;
      color: #1c2526;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.3s ease, background-color 0.3s ease;
      min-width: 120px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes bounceIn {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-30px); }
      60% { transform: translateY(-15px); }
    }

    @keyframes popIn {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
      80% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    @media (max-width: 768px) {
      .welcome-screen {
        margin: 10px;
        padding: 15px;
      }

      .mode-selection {
        flex-direction: column;
        gap: 10px;
      }

      .mode-button, .difficulty-button, .how-to-play-button, .home-link {
        padding: 12px 20px;
        font-size: 16px;
        min-width: 160px;
      }

      .guide-section {
        margin: 20px 10px;
        padding: 15px;
      }

      .game-info {
        font-size: 16px;
      }

      .chessboard {
        border-width: 3px;
      }
    }
  </style>
</head>
<body>
  <div class="welcome-screen" id="welcomeScreen">
    <div class="home-link-container">
      <a class="home-link" href="./" aria-label="Return to home page">Home</a>
    </div>
    <h1>Play Chess Online Free at Toolpix Games</h1>
    <p>Welcome to Toolpix Games, your ultimate destination to play chess online for free! Enjoy our feature-rich chess game, whether you're a beginner learning chess or a seasoned player mastering chess strategies. Play against a smart AI bot in single-player mode or challenge friends in two-player mode. No downloads needed‚Äîour online chess game works seamlessly on any device!</p>
    
    <h2>Why Play Chess Online with Toolpix Games?</h2>
    <ul>
      <li><strong>Free to Play:</strong> Enjoy chess online without any cost.</li>
      <li><strong>Single-Player Mode:</strong> Test your skills against our intelligent chess AI with adjustable difficulty levels (Easy, Medium, Hard).</li>
      <li><strong>Two-Player Mode:</strong> Play chess with friends or family on the same device.</li>
      <li><strong>Learn Chess:</strong> Our comprehensive guide below teaches you chess rules, strategies, and tips for beginners.</li>
      <li><strong>Accessible Anywhere:</strong> Play on mobile, tablet, or desktop without downloads.</li>
      <li><strong>SEO-Optimized:</strong> Find us easily when searching for "play chess online," "free chess game," or "online chess against computer."</li>
    </ul>

    <h3 id="welcomeTitle">Choose Your Game Mode</h3>
    <div class="mode-selection" id="modeSelection">
      <button class="mode-button" onclick="showDifficultySelection()" aria-label="Start single-player game against bot">Single Player (vs Bot)</button>
      <button class="mode-button" onclick="startGame('multi', 'none')" aria-label="Start two-player game">Two Players</button>
    </div>
    
    <div class="difficulty-selection" id="difficultySelection">
      <select id="difficultyLevel" aria-label="Select difficulty level">
        <option value="easy">Easy</option>
        <option value="medium">Medium</option>
        <option value="hard" selected>Hard</option>
      </select>
      <div class="difficulty-buttons">
        <button class="difficulty-button" onclick="startGame('single', document.getElementById('difficultyLevel').value)" aria-label="Start single-player game">Start Game</button>
        <button class="difficulty-button" onclick="backToModeSelection()" aria-label="Back to mode selection">Back</button>
      </div>
    </div>

    <button class="how-to-play-button" onclick="scrollToGuide()" aria-label="Learn how to play chess">How to Play</button>

    <div class="guide-section" id="guideSection">
      <h2>How to Play Chess: A Beginner's Guide</h2>
      <p>Chess is a timeless strategy board game played on an 8x8 chessboard between two players. Whether you're new to chess or looking to improve, this guide explains the rules of chess, how pieces move, and basic strategies to help you play chess online like a pro. Master the game with our easy-to-follow instructions!</p>
      
      <h3>Chess Game Objective</h3>
      <p>The goal of chess is to checkmate your opponent's king, meaning the king is under attack (in "check") and cannot escape. You can also win if your opponent resigns or if the game ends in a stalemate (draw).</p>
      
      <h3>Chess Pieces and Their Moves</h3>
      <ul>
        <li><strong>King:</strong> Moves one square in any direction (up, down, left, right, or diagonally). Protect your king to avoid checkmate.</li>
        <li><strong>Queen:</strong> Moves any number of squares in any direction (horizontally, vertically, or diagonally). The most powerful piece.</li>
        <li><strong>Rook:</strong> Moves any number of squares horizontally or vertically.</li>
        <li><strong>Bishop:</strong> Moves any number of squares diagonally.</li>
        <li><strong>Knight:</strong> Moves in an L-shape: two squares in one direction and one square perpendicular. It can jump over other pieces.</li>
        <li><strong>Pawn:</strong> Moves forward one square (or two from its starting position). Captures diagonally. Pawns can promote to a queen, rook, bishop, or knight if they reach the opponent's end of the board.</li>
      </ul>
      
      <h3>Basic Chess Rules</h3>
      <ol>
        <li><strong>Setup:</strong> The chessboard is set up with white pieces on rows 1 and 2, black pieces on rows 7 and 8. The bottom-right square (h1 for white, h8 for black) is always light-colored.</li>
        <li><strong>Turns:</strong> White moves first. Players alternate turns, moving one piece per turn.</li>
        <li><strong>Capturing:</strong> Move your piece to an opponent's piece's square to capture it, removing it from the board.</li>
        <li><strong>Check and Checkmate:</strong> A king in check must escape by moving, capturing the attacking piece, or blocking the attack. If escape is impossible, it's checkmate, and the game ends.</li>
        <li><strong>Special Moves:</strong>
          <ul>
            <li><strong>Castling:</strong> Move the king two squares toward a rook and place the rook on the king's other side (if neither has moved and the path is clear).</li>
            <li><strong>En Passant:</strong> A special pawn capture when an opponent's pawn advances two squares from its starting position, allowing your pawn to capture it as if it moved one square.</li>
            <li><strong>Pawn Promotion:</strong> A pawn reaching the opponent's end of the board can be promoted to a queen, rook, bishop, or knight.</li>
          </ul>
        </li>
        <li><strong>Draws:</strong> The game can end in a draw via stalemate (no legal moves without check), threefold repetition, the fifty-move rule, or mutual agreement.</li>
      </ol>
      
      <h3>Chess Strategies for Beginners</h3>
      <ul>
        <li><strong>Control the Center:</strong> Occupy or influence the central squares (d4, d5, e4, e5) with pawns and pieces to gain board control.</li>
        <li><strong>Develop Pieces Early:</strong> Move knights and bishops to active squares before moving the same piece multiple times.</li>
        <li><strong>Protect Your King:</strong> Castle early to safeguard your king and activate your rook.</li>
        <li><strong>Plan Ahead:</strong> Think about your opponent's possible moves and plan your strategy accordingly.</li>
        <li><strong>Avoid Early Queen Moves:</strong> Moving the queen too early can expose it to attacks, losing tempo.</li>
      </ul>
      
      <h3>Why Play Chess Online?</h3>
      <p>Playing chess online at Toolpix Games offers a convenient way to practice and improve. Our chess game features an AI opponent with adjustable difficulty, perfect for beginners and advanced players. Learn chess strategies, practice tactics, and enjoy free online chess anytime, anywhere. Whether you're exploring chess openings, practicing endgames, or mastering checkmate patterns, our platform is designed to help you grow as a player.</p>
      
      <h3>Ready to Play?</h3>
      <p>Jump into a game now or scroll up to choose your mode! Play chess online free, challenge our AI, or enjoy a two-player chess match with friends. Toolpix Games is your go-to platform for online chess fun!</p>
    </div>
    
    <div class="ad-banner">Advertisement</div>
  </div>

  <div class="game-section" id="gameSection">
    <div class="back-button-container">
      <button class="back-button" onclick="backToWelcome()" aria-label="Return to welcome screen">Back</button>
    </div>
    <div class="chessboard-container">
      <div class="chessboard" id="chessboard"></div>
    </div>
    <div class="game-info" id="gameInfo">White's turn</div>
    <div class="ad-banner">Advertisement</div>
  </div>

  <div class="popup" id="gamePopup">
    <h3 id="popupMessage"></h3>
    <div class="popup-buttons">
      <button class="popup-button" onclick="restartGame()" aria-label="Restart the game">Restart Game</button>
      <button class="popup-button" onclick="backToWelcome()" aria-label="Return to welcome screen">Back</button>
    </div>
  </div>

  <script>
    // Game state and configuration
    const initialBoard = [
      ['br', 'bn', 'bb', 'bq', 'bk', 'bb', 'bn', 'br'],
      ['bp', 'bp', 'bp', 'bp', 'bp', 'bp', 'bp', 'bp'],
      ['', '', '', '', '', '', '', ''],
      ['', '', '', '', '', '', '', ''],
      ['', '', '', '', '', '', '', ''],
      ['', '', '', '', '', '', '', ''],
      ['wp', 'wp', 'wp', 'wp', 'wp', 'wp', 'wp', 'wp'],
      ['wr', 'wn', 'wb', 'wq', 'wk', 'wb', 'wn', 'wr']
    ];

    const pieceImages = {
      'wp': 'https://www.chess.com/chess-themes/pieces/neo/150/wp.png',
      'wn': 'https://www.chess.com/chess-themes/pieces/neo/150/wn.png',
      'wb': 'https://www.chess.com/chess-themes/pieces/neo/150/wb.png',
      'wr': 'https://www.chess.com/chess-themes/pieces/neo/150/wr.png',
      'wq': 'https://www.chess.com/chess-themes/pieces/neo/150/wq.png',
      'wk': 'https://www.chess.com/chess-themes/pieces/neo/150/wk.png',
      'bp': 'https://www.chess.com/chess-themes/pieces/neo/150/bp.png',
      'bn': 'https://www.chess.com/chess-themes/pieces/neo/150/bn.png',
      'bb': 'https://www.chess.com/chess-themes/pieces/neo/150/bb.png',
      'br': 'https://www.chess.com/chess-themes/pieces/neo/150/br.png',
      'bq': 'https://www.chess.com/chess-themes/pieces/neo/150/bq.png',
      'bk': 'https://www.chess.com/chess-themes/pieces/neo/150/bk.png'
    };

    // Game state variables
    let board = [];
    let currentPlayer = 'w';
    let gameActive = false;
    let gameMode = '';
    let difficulty = 'hard';
    let selectedPiece = null;
    let possibleMoves = [];

    // Initialize the game
    function initGame() {
      const savedGame = localStorage.getItem('chessGame');
      if (savedGame) {
        const gameState = JSON.parse(savedGame);
        board = gameState.board;
        currentPlayer = gameState.currentPlayer;
        gameMode = gameState.gameMode;
        difficulty = gameState.difficulty || 'hard';
        gameActive = true;

        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('gameSection').style.display = 'flex';
        document.getElementById('gameInfo').textContent = `${currentPlayer === 'w' ? 'White' : 'Black'}'s turn`;
        initChessboard();
        renderBoard();
        
        if (gameMode === 'single' && currentPlayer === 'b') {
          setTimeout(botMove, 500);
        }
      }
    }

    // Initialize chessboard UI
    function initChessboard() {
      const chessboard = document.getElementById('chessboard');
      chessboard.innerHTML = '';
      chessboard.style.gridTemplateColumns = `repeat(8, 1fr)`;
      
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.row = r;
          cell.dataset.col = c;
          cell.classList.add((r + c) % 2 === 0 ? 'light' : 'dark');
          chessboard.appendChild(cell);
        }
      }
      chessboard.addEventListener('click', handleCellClick);
    }

    // UI Navigation Functions
    function showDifficultySelection() {
      document.getElementById('modeSelection').style.display = 'none';
      document.getElementById('difficultySelection').style.display = 'flex';
      document.getElementById('welcomeTitle').textContent = 'Select Difficulty';
    }

    function backToModeSelection() {
      document.getElementById('modeSelection').style.display = 'flex';
      document.getElementById('difficultySelection').style.display = 'none';
      document.getElementById('welcomeTitle').textContent = 'Choose Your Game Mode';
    }

    function scrollToGuide() {
      document.getElementById('guideSection').scrollIntoView({ behavior: 'smooth' });
    }

    function startGame(mode, diff) {
      gameMode = mode;
      difficulty = diff || 'none';
      gameActive = true;
      board = initialBoard.map(row => row.slice());
      currentPlayer = 'w';
      selectedPiece = null;
      possibleMoves = [];
      
      saveGameState();
      
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('gameSection').style.display = 'flex';
      document.getElementById('gameInfo').textContent = "White's turn";
      document.getElementById('gamePopup').style.display = 'none';
      initChessboard();
      renderBoard();
    }

    function backToWelcome() {
      gameActive = false;
      localStorage.removeItem('chessGame');
      document.getElementById('gameSection').style.display = 'none';
      document.getElementById('welcomeScreen').style.display = 'flex';
      document.getElementById('gamePopup').style.display = 'none';
      document.getElementById('modeSelection').style.display = 'flex';
      document.getElementById('difficultySelection').style.display = 'none';
      document.getElementById('welcomeTitle').textContent = 'Choose Your Game Mode';
    }

    // Save game state to localStorage
    function saveGameState() {
      const gameState = {
        board: board,
        currentPlayer: currentPlayer,
        gameMode: gameMode,
        difficulty: difficulty
      };
      localStorage.setItem('chessGame', JSON.stringify(gameState));
    }

    // Render the board
    function renderBoard() {
      const cells = document.querySelectorAll('.cell');
      cells.forEach(cell => {
        const row = parseInt(cell.dataset.row);
        const col = parseInt(cell.dataset.col);
        const piece = board[row][col];
        cell.innerHTML = '';
        cell.classList.remove('selected', 'possible-move');
        
        if (piece) {
          const img = document.createElement('img');
          img.src = pieceImages[piece];
          img.alt = piece;
          cell.appendChild(img);
        }
        
        if (selectedPiece && selectedPiece.row === row && selectedPiece.col === col) {
          cell.classList.add('selected');
        }
        
        if (possibleMoves.some(m => m.row === row && m.col === col)) {
          cell.classList.add('possible-move');
        }
      });
    }

    // Handle cell clicks
    function handleCellClick(event) {
      if (!gameActive) return;
      
      const cell = event.target.closest('.cell');
      if (!cell) return;
      
      const row = parseInt(cell.dataset.row);
      const col = parseInt(cell.dataset.col);

      if (selectedPiece) {
        const move = possibleMoves.find(m => m.row === row && m.col === col);
        if (move) {
          makeMove(selectedPiece.row, selectedPiece.col, row, col);
        }
        selectedPiece = null;
        possibleMoves = [];
        renderBoard();
      } else {
        const piece = board[row][col];
        if (piece && piece[0] === currentPlayer) {
          selectedPiece = { row, col };
          possibleMoves = getLegalMoves(row, col);
          renderBoard();
        }
      }
    }

    // Chess move logic
    function makeMove(fromRow, fromCol, toRow, toCol) {
      const piece = board[fromRow][fromCol];
      
      board[toRow][toCol] = piece;
      board[fromRow][fromCol] = '';
      
      currentPlayer = currentPlayer === 'w' ? 'b' : 'w';
      document.getElementById('gameInfo').textContent = `${currentPlayer === 'w' ? 'White' : 'Black'}'s turn`;
      
      saveGameState();
      
      if (isCheckmate(currentPlayer)) {
        showPopup(`${currentPlayer === 'w' ? 'Black' : 'White'} wins by checkmate!`);
        gameActive = false;
        localStorage.removeItem('chessGame');
      } else if (isStalemate(currentPlayer)) {
        showPopup("Stalemate! It's a draw.");
        gameActive = false;
        localStorage.removeItem('chessGame');
      } else if (gameMode === 'single' && currentPlayer === 'b') {
        setTimeout(botMove, 500);
      }
    }

    // Bot move logic
    function botMove() {
      if (!gameActive || currentPlayer !== 'b') return;
      
      const allMoves = getAllLegalMoves('b');
      if (allMoves.length === 0) {
        if (isInCheck('b')) {
          showPopup('White wins by checkmate!');
        } else {
          showPopup("Stalemate! It's a draw.");
        }
        gameActive = false;
        localStorage.removeItem('chessGame');
        return;
      }
      
      let move;
      if (difficulty === 'easy') {
        move = allMoves[Math.floor(Math.random() * allMoves.length)];
      } else if (difficulty === 'medium') {
        const captureMoves = allMoves.filter(m => board[m.toRow][m.toCol] !== '');
        move = captureMoves.length > 0 ? 
          captureMoves[Math.floor(Math.random() * captureMoves.length)] : 
          allMoves[Math.floor(Math.random() * allMoves.length)];
      } else if (difficulty === 'hard') {
        let bestScore = -Infinity;
        for (const m of allMoves) {
          const originalPiece = board[m.toRow][m.toCol];
          board[m.toRow][m.toCol] = board[m.fromRow][m.fromCol];
          board[m.fromRow][m.fromCol] = '';
          const score = minimax(2, false);
          board[m.fromRow][m.fromCol] = board[m.toRow][m.toCol];
          board[m.toRow][m.toCol] = originalPiece;
          if (score > bestScore) {
            bestScore = score;
            move = m;
          }
        }
      }
      
      makeMove(move.fromRow, move.fromCol, move.toRow, move.toCol);
      renderBoard();
    }

    // Chess rules implementation
    function getPseudoLegalMoves(row, col) {
      const piece = board[row][col];
      if (!piece) return [];
      
      const color = piece[0];
      const type = piece[1];
      
      if (type === 'p') return getPawnMoves(row, col, color);
      if (type === 'n') return getKnightMoves(row, col, color);
      if (type === 'b') return getBishopMoves(row, col, color);
      if (type === 'r') return getRookMoves(row, col, color);
      if (type === 'q') return getQueenMoves(row, col, color);
      if (type === 'k') return getKingMoves(row, col, color);
      return [];
    }

    function getLegalMoves(row, col) {
      const piece = board[row][col];
      if (!piece || piece[0] !== currentPlayer) return [];
      
      const pseudoMoves = getPseudoLegalMoves(row, col);
      const legalMoves = [];
      
      for (const move of pseudoMoves) {
        const originalPiece = board[move.row][move.col];
        board[move.row][move.col] = piece;
        board[row][col] = '';
        
        if (!isInCheck(currentPlayer)) {
          legalMoves.push(move);
        }
        
        board[row][col] = piece;
        board[move.row][move.col] = originalPiece;
      }
      
      return legalMoves;
    }

    function getPawnMoves(row, col, color) {
      const moves = [];
      const dir = color === 'w' ? -1 : 1;
      const startRow = color === 'w' ? 6 : 1;
      
      const newRow = row + dir;
      if (newRow >= 0 && newRow < 8 && !board[newRow][col]) {
        moves.push({ row: newRow, col });
        if (row === startRow && !board[row + 2 * dir][col]) {
          moves.push({ row: row + 2 * dir, col });
        }
      }
      
      const captures = [[newRow, col - 1], [newRow, col + 1]];
      for (const [r, c] of captures) {
        if (r >= 0 && r < 8 && c >= 0 && c < 8 && board[r][c] && board[r][c][0] !== color) {
          moves.push({ row: r, col: c });
        }
      }
      
      return moves;
    }

    function getKnightMoves(row, col, color) {
      const moves = [];
      const deltas = [
        [-2, -1], [-2, 1], [2, -1], [2, 1],
        [-1, -2], [-1, 2], [1, -2], [1, 2]
      ];
      
      for (const [dr, dc] of deltas) {
        const r = row + dr;
        const c = col + dc;
        if (r >= 0 && r < 8 && c >= 0 && c < 8) {
          const target = board[r][c];
          if (!target || target[0] !== color) {
            moves.push({ row: r, col: c });
          }
        }
      }
      
      return moves;
    }

    function getBishopMoves(row, col, color) {
      const moves = [];
      const directions = [[-1, -1], [-1, 1], [1, -1], [1, 1]];
      
      for (const [dr, dc] of directions) {
        let r = row + dr;
        let c = col + dc;
        while (r >= 0 && r < 8 && c >= 0 && c < 8) {
          const target = board[r][c];
          if (!target) {
            moves.push({ row: r, col: c });
          } else {
            if (target[0] !== color) moves.push({ row: r, col: c });
            break;
          }
          r += dr;
          c += dc;
        }
      }
      
      return moves;
    }

    function getRookMoves(row, col, color) {
      const moves = [];
      const directions = [[-1, 0], [1, 0], [0, -1], [0, 1]];
      
      for (const [dr, dc] of directions) {
        let r = row + dr;
        let c = col + dc;
        while (r >= 0 && r < 8 && c >= 0 && c < 8) {
          const target = board[r][c];
          if (!target) {
            moves.push({ row: r, col: c });
          } else {
            if (target[0] !== color) moves.push({ row: r, col: c });
            break;
          }
          r += dr;
          c += dc;
        }
      }
      
      return moves;
    }

    function getQueenMoves(row, col, color) {
      return [...getRookMoves(row, col, color), ...getBishopMoves(row, col, color)];
    }

    function getKingMoves(row, col, color) {
      const moves = [];
      const deltas = [
        [-1, -1], [-1, 0], [-1, 1],
        [0, -1],           [0, 1],
        [1, -1],  [1, 0],  [1, 1]
      ];
      
      for (const [dr, dc] of deltas) {
        const r = row + dr;
        const c = col + dc;
        if (r >= 0 && r < 8 && c >= 0 && c < 8) {
          const target = board[r][c];
          if (!target || target[0] !== color) {
            moves.push({ row: r, col: c });
          }
        }
      }
      
      return moves;
    }

    function findKing(player) {
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
          if (board[r][c] === player + 'k') return { row: r, col: c };
        }
      }
      return null;
    }

    function isInCheck(player) {
      const kingPos = findKing(player);
      if (!kingPos) return false;
      
      const opponent = player === 'w' ? 'b' : 'w';
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
          const piece = board[r][c];
          if (piece && piece[0] === opponent) {
            const moves = getPseudoLegalMoves(r, c);
            if (moves.some(m => m.row === kingPos.row && m.col === kingPos.col)) {
              return true;
            }
          }
        }
      }
      return false;
    }

    function getAllLegalMoves(player) {
      const moves = [];
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
          const piece = board[r][c];
          if (piece && piece[0] === player) {
            const pieceMoves = getLegalMoves(r, c);
            pieceMoves.forEach(m => moves.push({ 
              fromRow: r, 
              fromCol: c, 
              toRow: m.row, 
              toCol: m.col 
            }));
          }
        }
      }
      return moves;
    }

    function isCheckmate(player) {
      return isInCheck(player) && getAllLegalMoves(player).length === 0;
    }

    function isStalemate(player) {
      return !isInCheck(player) && getAllLegalMoves(player).length === 0;
    }

    function minimax(depth, isMaximizing) {
      if (depth === 0 || isCheckmate('w') || isCheckmate('b') || isStalemate('w') || isStalemate('b')) {
        return evaluateBoard();
      }
      
      if (isMaximizing) {
        let bestScore = -Infinity;
        const moves = getAllLegalMoves('b');
        for (const m of moves) {
          const originalPiece = board[m.toRow][m.toCol];
          board[m.toRow][m.toCol] = board[m.fromRow][m.fromCol];
          board[m.fromRow][m.fromCol] = '';
          const score = minimax(depth - 1, false);
          board[m.fromRow][m.fromCol] = board[m.toRow][m.toCol];
          board[m.toRow][m.toCol] = originalPiece;
          bestScore = Math.max(score, bestScore);
        }
        return bestScore;
      } else {
        let bestScore = Infinity;
        const moves = getAllLegalMoves('w');
        for (const m of moves) {
          const originalPiece = board[m.toRow][m.toCol];
          board[m.toRow][m.toCol] = board[m.fromRow][m.fromCol];
          board[m.fromRow][m.fromCol] = '';
          const score = minimax(depth - 1, true);
          board[m.fromRow][m.fromCol] = board[m.toRow][m.toCol];
          board[m.toRow][m.toCol] = originalPiece;
          bestScore = Math.min(score, bestScore);
        }
        return bestScore;
      }
    }

    function evaluateBoard() {
      const pieceValues = { 'p': 1, 'n': 3, 'b': 3, 'r': 5, 'q': 9, 'k': 100 };
      let score = 0;
      
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
          const piece = board[r][c];
          if (piece) {
            const value = pieceValues[piece[1]] || 0;
            score += piece[0] === 'w' ? value : -value;
          }
        }
      }
      return score;
    }

    // UI Helpers
    function showPopup(message) {
      document.getElementById('popupMessage').textContent = message;
      document.getElementById('gamePopup').style.display = 'block';
    }

    function restartGame() {
      startGame(gameMode, difficulty);
    }

    // Initialize the game when page loads
    window.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html>